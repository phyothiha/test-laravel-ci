name: Tests

on:
  pull_request
  
jobs:
    tests:
      runs-on: ubuntu-latest
      
      # services:
      #   redis:
      #     image: redis:7.4
      #     ports: 
      #       - 6379:6379
      
      steps:
        - name: Checkout code
          uses: actions/checkout@v4.2.2

        - name: Setup PHP and Composer
          uses: shivammathur/setup-php@2.32.0
          with:
            php-version: '8.3'
            tools: composer:v2
        
        - name: Get composer cache dir
          id: composer-cache-dir
          run: echo dir=$(composer config cache-files-dir) >> $GITHUB_OUTPUT
        
        - name: Cache dependencies
          uses: actions/cache@v4.2.0
          with:
            key: composer-cache-${{ hashFiles('**/composer.lock') }}
            path: ${{ steps.composer-cache-dir.outputs.dir }}
            restore-keys: composer-cache-
          
        - name: Install dependencies
          run: composer install -q --no-interaction --no-progress
        
        - name: Prep app
          run: |
            cp .env.example .env
            php artisan key:generate
          
        - name: Run Tests
          env:
            DB_CONNECTION: sqlite
            DB_DATABASE: ":memory:"
          run: php artisan test --compact